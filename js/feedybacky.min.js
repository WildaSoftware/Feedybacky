const feedybackyScriptName="feedybacky.min.js",feedybackyPortalEndpoint="https://api.feedybacky.com/issue",checkboxVisibleOption="visible",checkboxAutoEnableOption="autoEnable",checkboxAutoDisableOption="autoDisable",checkboxOptions=[checkboxVisibleOption,checkboxAutoEnableOption,"autoDisable"],orderDescriptionPart="description",orderMessagePart="message",orderEmailPart="email",orderExplanationPart="explanation",orderScreenshotCheckboxPart="screenshot",orderMetadataCheckboxPart="metadata",orderHistoryCheckboxPart="history",orderTermsAcceptedCheckboxPart="termsAccepted",orderPersonalDataAcceptedCheckboxPart="personalDataAccepted",orderNotePart="note",orderCategoryPart="category",orderPriorityPart="priority",orderParts=["description","message","email","category","priority","explanation","screenshot","metadata","history","termsAccepted","personalDataAccepted","note"],orderTitlePart="title",orderSendPart="send",orderPoweredPart="powered",containerParts=["description","message","email","category","priority","explanation","screenshot","metadata","history","note","title","send","powered","termsAccepted","personalDataAccepted"],alertTypeSuccess="success",alertTypeFailure="error",alertTypePending="pending",termsAcceptedStorageItem="feedybacky_termsDataAccepted",personalDataAcceptedStorageItem="feedybacky_personalDataAccepted",visitedUrlsStorageItem="feedybacky_visitedUrls",defaultTheme="default",darkTheme="dark",standardThemes=["default","dark"],screenshotMethodHtml2Canvas="html2canvas",screenshotMethodMediaDevice="mediaDevice",allowedScreenshotMethods=["html2canvas","mediaDevice"],messageTypeText="text",messageTypeVoice="voice",allowedMessageTypes=["text","voice"],messageAudioMaxLength=1e4;class FeedybackyPayload{add(e,t){this[e]=t}}class Feedybacky{constructor(e,t){this.params=t,this.basePath=null,this.consoleErrors=[],this.importDependencies(),this.container=document.getElementById(e),this.extraInfoFunction=t.extraInfo||null,this.beforeSubmitFunction=t.beforeSubmit||null,this.prefix=t.prefix||null,this.onSubmitUrlSuccess=t.onSubmitUrlSuccess||null,this.onSubmitUrlError=t.onSubmitUrlError||null,this.theme=t.theme||"default",this.allowedThemes=t.allowedThemes||standardThemes,this.modifiedScreenshot=null,this.allowedThemes.includes(this.theme)||(this.theme="default"),this.screenshotMethod=t.screenshotMethod||"html2canvas",allowedScreenshotMethods.includes(this.screenshotMethod)||(this.screenshotMethod="html2canvas"),this.eventHistory=[],this.historyLimit=t.historyLimit||null,this.params.urlTracking=this.params.urlTracking,void 0===this.params.urlTracking?this.params.urlTracking=!0:"false"===this.params.urlTracking&&(this.params.urlTracking=!1),this.params.urlTracking&&(this.urlTrackingLimit=t.urlTrackingLimit||15,this.initUrlTracking()),this.params.classes=this.params.classes||{};for(let e=0;e<containerParts.length;++e)this.params.classes[containerParts[e]]=this.params.classes[containerParts[e]]||"";if(this.params.screenshotField&&checkboxOptions.includes(this.params.screenshotField)||(this.params.screenshotField=checkboxVisibleOption),this.params.metadataField&&checkboxOptions.includes(this.params.metadataField)||(this.params.metadataField=checkboxVisibleOption),this.params.historyField&&checkboxOptions.includes(this.params.historyField)||(this.params.historyField=checkboxVisibleOption),this.params.side&&["left","right"].includes(this.params.side)||(this.params.side="right"),this.params.order){const e=this.params.order.replace(/\s/g,"").split(","),t=[],s=orderParts.map((function(e){return e.toLowerCase()}));for(let a=0;a<e.length;++a)s.includes(e[a].toLowerCase())&&t.push(e[a]);this.params.order=t.join(",")}else this.params.order="description,message,email,category,priority,explanation,screenshot,metadata,history,termsAccepted,personalDataAccepted,note";if("boolean"!=typeof this.params.alertAfterRequest&&(this.params.alertAfterRequest=!0),this.params.emailField=this.params.emailField||!1,this.params.expandMessageLink=this.params.expandMessageLink||!1,this.params.priorityField=this.params.priorityField||!1,!0!==this.params.emailField&&(this.params.emailField=!1),!0!==this.params.expandMessageLink&&(this.params.expandMessageLink=!1),!0!==this.params.priorityField&&(this.params.priorityField=!1),this.params.categories=t.categories||[],void 0===this.params.adBlockDetected){let e=document.createElement("div");e.innerHTML="&nbsp;",e.className="adsbox",document.body.appendChild(e),window.setTimeout((()=>{0===e.offsetHeight?this.params.adBlockDetected=!0:this.params.adBlockDetected=!1,document.body.removeChild(e)}),60)}this.params.termsUrl=this.params.termsUrl||"#",this.params.privacyPolicyUrl=this.params.privacyPolicyUrl||"#",!1!==this.params.allowScreenshotModification&&(this.params.allowScreenshotModification=!0),this.params.allowScreenshotModification&&(this.screenshotModification={baseImage:null,canvas:null,ctx:null,flag:null,selectedColor:"black",lineWidthPx:2,prevX:0,currX:0,prevY:0,currY:0,dotFlag:!1}),this.params.availableMessageTypes=this.params.availableMessageTypes&&this.params.availableMessageTypes.length>0?this.params.availableMessageTypes.filter((e=>allowedMessageTypes.includes(e))):["text"],this.params.activeMessageType=this.params.activeMessageType||this.params.availableMessageTypes[0],this.messageAudio=null,this.messageAudioLength=0,this.loadMessages().then((()=>{if(this.params.apiKey&&this.params.projectSymbol&&!this.params.onSubmitUrl&&(this.params.onSubmitUrl=feedybackyPortalEndpoint),this.initMinifiedContainer(),this.initExtendedContainer(),this.initAlertContainer(),this.setTheme(this.theme),document.getElementById("feedybacky-container-hide-button").addEventListener("click",(e=>{this.close()})),this.params.onSubmit&&document.getElementById("feedybacky-form").addEventListener("submit",this.params.onSubmit),this.params.onSubmitUrl&&document.getElementById("feedybacky-form").addEventListener("submit",(e=>{e.preventDefault(),this.clearErrors(),this.validateForm()&&(this.prepareAndSendRequest(),this.showMinimalContainer())})),this.params.allowScreenshotModification){document.getElementById("feedybacky-form-screenshot-allowed").addEventListener("change",(e=>{e.target.checked?document.getElementById("feedybacky-form-screenshot-modify").style.display="inline":document.getElementById("feedybacky-form-screenshot-modify").style.display="none"})),document.getElementById("feedybacky-form-screenshot-allowed").dispatchEvent(new Event("change")),document.getElementById("feedybacky-form-screenshot-modify").addEventListener("click",(e=>{if(e.preventDefault(),this.screenshotModification.canvas)document.getElementById("feedybacky-screen-modification-modal").style.display="block";else{let t=e.target.innerHTML;e.target.innerHTML=this.params.texts.working,this.getScreenshot().then((s=>{this.initializeDrawing(s),document.getElementById("feedybacky-screen-modification-modal").style.display="block",e.target.innerHTML=t}))}})),document.getElementById("feedybacky-screen-modification-modal-close").addEventListener("click",(e=>{e.preventDefault(),document.getElementById("feedybacky-screen-modification-modal").style.display="none"})),document.getElementById("feedybacky-screen-modification-modal-save").addEventListener("click",(e=>{e.preventDefault(),this.saveScreenshotModification()})),document.getElementById("feedybacky-screen-modification-modal-clear").addEventListener("click",(e=>{e.preventDefault(),this.clearScreenshotModification()})),document.getElementById("feedybacky-screen-modification-modal-rescreen").addEventListener("click",(e=>{e.preventDefault();const t=document.getElementById("feedybacky-screen-modification-modal-save"),s=document.getElementById("feedybacky-screen-modification-modal-clear"),a=e.target;t.setAttribute("disabled","disabled"),s.setAttribute("disabled","disabled"),a.setAttribute("disabled","disabled"),a.value=this.params.texts.working,this.getScreenshot().then((e=>{this.initializeDrawing(e),t.removeAttribute("disabled"),s.removeAttribute("disabled"),a.removeAttribute("disabled"),a.value=this.params.texts.restartScreen}))}));let e=document.getElementsByClassName("feedybacky-color-change");for(let t=0;t<e.length;t++)e[t].addEventListener("click",(e=>{e.preventDefault(),this.screenshotModification.selectedColor=window.getComputedStyle(document.getElementById(e.target.id),null).getPropertyValue("background-color")}),!1)}const e=document.getElementById("feedybacky-form-description");e&&e.addEventListener("keydown",(e=>{e.ctrlKey&&13===e.keyCode&&(e.preventDefault(),document.getElementById("feedybacky-form-submit-button").click())})),document.getElementById("feedybacky-alert-container").addEventListener("click",(e=>{document.getElementById(e.srcElement.id).style.display="none"})),window.onerror=(e,t,s)=>(this.consoleErrors.push(`${e} ${t} ${s}`),!1),[checkboxVisibleOption,checkboxAutoEnableOption].includes(this.params.historyField)&&this.initEventHistoryGathering();const t=document.getElementById("feedybacky-form-description-expand");t&&t.addEventListener("click",(e=>{e.preventDefault(),document.getElementById("feedybacky-container-extended").className+=" expanded",e.target.parentNode.removeChild(e.target)}));const s=document.getElementsByClassName("feedybacky-message-type-button"),a=document.getElementsByClassName("feedybacky-form-message-type"),i=document.getElementById("feedybacky-form-message-text");i&&i.addEventListener("click",(e=>{e.preventDefault();for(let e=0;e<s.length;++e)s[e].classList="feedybacky-message-type-button";for(let e=0;e<a.length;++e)a[e].style.display="none";e.target.classList="feedybacky-message-type-button feedybacky-button-active",document.getElementById("feedybacky-form-message-type-text").style.display="block",this.params.activeMessageType="text"}));const n=document.getElementById("feedybacky-form-message-voice");n&&n.addEventListener("click",(e=>{e.preventDefault();for(let e=0;e<s.length;++e)s[e].classList="feedybacky-message-type-button";for(let e=0;e<a.length;++e)a[e].style.display="none";e.target.classList="feedybacky-message-type-button feedybacky-button-active",document.getElementById("feedybacky-form-message-type-voice").style.display="block",this.params.activeMessageType="voice"}));const o=document.getElementById("feedybacky-voice-record"),r=document.getElementById("feedybacky-voice-stop"),c=document.getElementById("feedybacky-voice-play");let d=0;o&&r&&c&&o.addEventListener("click",(e=>{e.preventDefault(),navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{o.style.display="none",r.style.display="inline";const t=new MediaRecorder(e);t.start(),d=(new Date).getTime();const s=[];t.addEventListener("dataavailable",(e=>{s.push(e.data)})),t.addEventListener("stop",(()=>{o.style.display="inline",r.style.display="none",c.style.display="inline";const e=new Blob(s);let t=new window.FileReader;t.readAsDataURL(e),t.onloadend=()=>{let e=t.result;e=e.split(",")[1],this.messageAudio="data:audio/wav;base64,"+e}})),r.addEventListener("click",(e=>{e.preventDefault(),this.messageAudioLength=(new Date).getTime()-d,t.stop()})),c.addEventListener("click",(e=>{e.preventDefault(),new Audio(this.messageAudio).play()}))}))}))}))}async loadMessages(){this.defaultVars={language:"en",texts:{}},this.params.language=this.params.language||this.defaultVars.language,this.defaultVars.texts=await(async()=>{let e=null;if(this.basePath)await this.loadJsonFile(`${this.basePath}/i18n/${this.params.language}.json`,(t=>{e=t}),(async t=>{console.warn(`Feedybacky cannot load default language pack for ${this.params.language}. The default language pack will be loaded.`),await this.loadJsonFile(`${this.basePath}/i18n/${this.defaultVars.language}.json`,(t=>{e=t}))}));else try{e=require(`../i18n/${this.params.language}.json`)}catch(t){console.warn(`Feedybacky cannot load default language pack for ${this.params.language}. The default language pack will be loaded.`),e=require(`../i18n/${this.defaultVars.language}.json`)}return e})(),this.params.texts=this.params.texts||{},this.params.texts.powered=this.params.texts.hasOwnProperty("powered")?this.params.texts.powered:`${this.defaultVars.texts.powered} <a href="https://wildasoftware.pl/" target="_blank">Wilda Software</a>`;for(const[e,t]of Object.entries(this.defaultVars.texts))this.params.texts[e]=this.params.texts[e]||t}open(){this.showExtendedContainer()}close(){this.showMinimalContainer()}setTheme(e){if(!this.allowedThemes.includes(e))return;let t="feedybacky-container-theme-"+this.theme,s="feedybacky-container-theme-"+e;this.theme=e,this.minifiedContainer.classList.remove(t),this.extendedContainer.classList.remove(t),this.minifiedContainer.classList.add(s),this.extendedContainer.classList.add(s)}setScreenshotMethod(e){allowedScreenshotMethods.includes(e)&&(this.screenshotMethod=e)}initMinifiedContainer(){this.minifiedContainer=document.createElement("div"),this.minifiedContainer.id="feedybacky-container-minified",this.minifiedContainer.classList="feedybacky-container-"+this.params.side,this.minifiedContainer.title=this.params.texts.tooltip,this.minifiedContainer.innerHTML="<div></div>",this.minifiedContainer.setAttribute("data-html2canvas-ignore",!0),this.container.appendChild(this.minifiedContainer),this.minifiedContainer.addEventListener("click",(e=>{this.showExtendedContainer()}))}initExtendedContainer(){this.extendedContainer=document.createElement("div"),this.extendedContainer.id="feedybacky-container-extended",this.extendedContainer.classList="feedybacky-container-"+this.params.side,this.extendedContainer.setAttribute("data-html2canvas-ignore",!0),this.container.appendChild(this.extendedContainer);let e=`\n            <div id="feedybacky-description" class="${this.params.classes.description}">\n                ${this.params.texts.description}\n            </div>\n        `,t="";if(this.params.availableMessageTypes.length>1){let e="";for(let t=0;t<this.params.availableMessageTypes.length;++t){const s=this.params.availableMessageTypes[t];e+=`<button id="feedybacky-form-message-${s}" class="feedybacky-message-type-button ${s==this.params.activeMessageType?" feedybacky-button-active":""}">${this.params.texts["messageType"+(s.charAt(0).toUpperCase()+s.slice(1))]}</button>`}t=`\n                <div id="feedybacky-form-message-type-container">${e}</div>\n            `}let s="";for(let e=0;e<this.params.availableMessageTypes.length;++e){const t=this.params.availableMessageTypes[e];s+=`<div id="feedybacky-form-message-type-${t}" class="feedybacky-form-message-type" style="display: ${t==this.params.activeMessageType?"block":"none"}">`,"text"==t?(s+=`\n                    <textarea maxlength="1000" id="feedybacky-form-description" form="feedybacky-form" name="description" aria-required="true" class="${this.params.classes.message}"></textarea>\n                    <div id="feedybacky-form-description-error-message" class="feedybacky-error-message ${this.params.classes.message}"></div>\n                `,this.params.expandMessageLink&&(s+=`<a href="#" id="feedybacky-form-description-expand" class="${this.params.classes.message}">${this.params.texts.expand}</a>`)):"voice"==t&&(s+=`\n                    <button id="feedybacky-voice-record" class="feedybacky-voice-button ${this.params.classes.message}" title="${this.params.texts.voiceRecordTitle}">${this.params.texts.voiceRecord}</button>\n                    <button id="feedybacky-voice-stop" class="feedybacky-voice-button ${this.params.classes.message}" title="${this.params.texts.voiceStopRecordTitle}" style="display: none">${this.params.texts.voiceStopRecord}</button>\n                    <button id="feedybacky-voice-play" class="feedybacky-voice-button ${this.params.classes.message}" title="${this.params.texts.voicePlayTitle}" style="display: none">${this.params.texts.voicePlay}</button>\n                    <div id="feedybacky-form-description-error-message-voice" class="feedybacky-error-message ${this.params.classes.message}"></div>\n                `),s+="</div>"}let a="";this.params.emailField&&(a=`\n                <div id="feedybacky-container-email-description" class="${this.params.classes.email}">${this.params.texts.email}</div>\n                <input id="feedybacky-form-email" form="feedybacky-form" name="email" aria-required="true" class="${this.params.classes.email}"/>\n                <div id="feedybacky-form-email-error-message" class="feedybacky-error-message ${this.params.classes.email}" ></div>\n            `);let i="";if(this.params.categories.length>0){let e="";for(const t of this.params.categories)e+=`<option value="${t.value}">${t.label}</option>`;i=`\n                <div id="feedybacky-container-category-description" class="${this.params.classes.category}">${this.params.texts.category}</div>\n                <select name="category" id="feedybacky-form-category" form="feedybacky-form" aria-required="true" class="${this.params.classes.category}">\n                    ${e}\n                </select>\n            `}let n="";this.params.priorityField&&(n=`\n                <div id="feedybacky-container-priority-description" class="${this.params.classes.priority}">${this.params.texts.priority}</div>\n                <select name="priority" id="feedybacky-form-priority" form="feedybacky-form" aria-required="true" class="${this.params.classes.priority}">\n                    <option value="high">${this.params.texts.priorityHigh}</option>\n                    <option selected="selected" value="medium">${this.params.texts.priorityMedium}</option>\n                </select>\n            `);let o="";this.params.screenshotField==checkboxVisibleOption&&(o=`<label><input type="checkbox" id="feedybacky-form-screenshot-allowed" checked="true" class="${this.params.classes.screenshot}"/>${this.params.texts.screenshot}\n                    ${this.params.allowScreenshotModification?`<a href="#" id="feedybacky-form-screenshot-modify">${this.params.texts.modifyScreenshot}</a>`:""}\n                </label>`);let r="";this.params.metadataField==checkboxVisibleOption&&(r=`<label><input type="checkbox" id="feedybacky-form-metadata-allowed" checked="true" class="${this.params.classes.metadata}"/>${this.params.texts.metadata}</label>`);let c="";this.params.historyField==checkboxVisibleOption&&(c=`<label><input type="checkbox" id="feedybacky-form-history-allowed" checked="true" class="${this.params.classes.history}"/>${this.params.texts.history}</label>`);let d="";(o||r||c)&&(d=`<div id="feedybacky-container-additional-description" class="${this.params.classes.explanation}">${this.params.texts.additionalDataInformation}</div>`);const l=this.params.onSubmitUrl?this.params.onSubmitUrl.toLowerCase():"",h=feedybackyPortalEndpoint.toLowerCase();let m="",y="";if(l.includes(h)&&h.includes(l)){const e=localStorage.getItem(termsAcceptedStorageItem)>0?'checked="true"':"",t=this.params.texts.termsAccepted.replace("{termsUrl}",this.params.termsUrl);m=`\n                <label><input type="checkbox" id="feedybacky-form-terms-accepted" ${e} class="${this.params.classes.termsAccepted}"/>${t}</label>\n                <div id="feedybacky-form-terms-accepted-error-message" class="feedybacky-error-message ${this.params.classes.termsAccepted}" ></div>\n            `;const s=localStorage.getItem(personalDataAcceptedStorageItem)>0?'checked="true"':"",a=this.params.texts.personalDataAccepted.replace("{privacyPolicyUrl}",this.params.privacyPolicyUrl);y=`\n                <label><input type="checkbox" id="feedybacky-form-personal-data-accepted" ${s} class="${this.params.classes.personalDataAccepted}"/>${a}</label>\n                <div id="feedybacky-form-personal-data-accepted-error-message" class="feedybacky-error-message ${this.params.classes.personalDataAccepted}" ></div>\n            `}let p="";this.params.texts.note&&(p=`<div id="feedybacky-container-note" class="${this.params.classes.note}">${this.params.texts.note}</div>`);const f={};f.description=`${e}`,f.message=`${t}${s}`,f.explanation=`${d}`,f.email=`${a}`,f.category=`${i}`,f.priority=`${n}`,f.screenshot=`${o}`,f.metadata=`${r}`,f.history=`${c}`,f.termsAccepted=`${m}`,f.personalDataAccepted=`${y}`,f.note=`${p}`;let u="";const g=this.params.order.split(",");for(let e=0;e<g.length;++e)u+=`${f[g[e]]}`;let b=`\n            <div id="feedybacky-container-title" class="${this.params.classes.title}">${this.params.texts.title}</div>\n            <div id="feedybacky-container-hide-button" aria-label="Close">\n                <span aria-hidden="true">&times;</span>\n            </div>\n            <form id="feedybacky-form">\n                ${u}\n                <button id="feedybacky-form-submit-button" type="submit" class="${this.params.classes.send}">${this.params.texts.send}</button>\n            </form>\n            <div id="feedybacky-container-powered" class="${this.params.classes.powered}">\n                ${this.params.texts.powered}\n            </div>\n        `;this.params.allowScreenshotModification&&(b+=`\n                <div id="feedybacky-screen-modification-modal">\n                    <div class="modal-content">\n                        <span id="feedybacky-screen-modification-modal-close">&times;</span>\n                        \n                        <div id="feedybacky-canvas-container">\n                            <div class="feedybacky-action-container">\n                                <div class="feedybacky-color-change-container">\n                                    <div class="feedybacky-color-change" id="feedybacky-green"></div>\n                                    <div class="feedybacky-color-change" id="feedybacky-blue"></div>\n                                    <div class="feedybacky-color-change" id="feedybacky-red"></div>\n                                    <div class="feedybacky-color-change" id="feedybacky-yellow"></div>\n                                    <div class="feedybacky-color-change" id="feedybacky-orange"></div>\n                                    <div class="feedybacky-color-change" id="feedybacky-black"></div>\n                                </div>\n                                <div class="feedybacky-inputs-container">\n                                    <input type="button" value="${this.params.texts.save}" id="feedybacky-screen-modification-modal-save">\n                                    <input type="button" value="${this.params.texts.clearMarkups}" id="feedybacky-screen-modification-modal-clear">\n                                    <input type="button" value="${this.params.texts.restartScreen}" id="feedybacky-screen-modification-modal-rescreen">\n                                </div>\n                            </div>\n                        </div>                             \n                    </div>\n                </div>\n            `),this.extendedContainer.innerHTML=b}initAlertContainer(){this.alertContainer=document.createElement("div"),this.alertContainer.id="feedybacky-alert-container",this.alertContainer.setAttribute("data-html2canvas-ignore",!0),this.container.appendChild(this.alertContainer)}clearErrors(){let e=document.getElementsByClassName("feedybacky-error-message");for(let t=0;t<e.length;++t)e[t].innerText=""}validateForm(){let e=document.getElementById("feedybacky-form-description"),t=document.getElementById("feedybacky-form-email"),s=document.getElementById("feedybacky-form-terms-accepted"),a=document.getElementById("feedybacky-form-personal-data-accepted"),i=!0;return e&&"text"==this.params.activeMessageType&&!e.value&&(document.getElementById("feedybacky-form-description-error-message").innerText=this.params.texts.descriptionErrorEmpty,i=!1),"voice"!=this.params.activeMessageType||this.messageAudio||(document.getElementById("feedybacky-form-description-error-message-voice").innerText=this.params.texts.descriptionErrorEmpty,i=!1),"voice"==this.params.activeMessageType&&this.messageAudioLength>1e4&&(document.getElementById("feedybacky-form-description-error-message-voice").innerText=this.params.texts.descriptionErrorVoiceTooLong+10,i=!1),t&&!t.value&&(document.getElementById("feedybacky-form-email-error-message").innerText=this.params.texts.emailErrorEmpty,i=!1),s&&!s.checked&&(document.getElementById("feedybacky-form-terms-accepted-error-message").innerText=this.params.texts.termsAcceptedErrorNotChecked,i=!1),a&&!a.checked&&(document.getElementById("feedybacky-form-personal-data-accepted-error-message").innerText=this.params.texts.personalDataAcceptedErrorNotChecked,i=!1),i}prepareAndSendRequest(){const e=document.getElementById("feedybacky-form-description"),t=this.messageAudio,s=document.getElementById("feedybacky-form-email"),a=document.getElementById("feedybacky-form-category"),i=document.getElementById("feedybacky-form-priority");let n=new FeedybackyPayload;n.timestamp=new Date,n.url=window.location.href,n.errors=this.consoleErrors,n.messageType=this.params.activeMessageType,"text"==this.params.activeMessageType?n.message=e.value:"voice"==this.params.activeMessageType&&(n.message=t),s&&(n.email=s.value),a&&(n.category=a.value),i&&(n.priority=i.value),this.prefix&&(n.prefix=this.prefix),this.params.apiKey&&(n.apiKey=this.params.apiKey),this.params.projectSymbol&&(n.projectSymbol=this.params.projectSymbol);const o=document.getElementById("feedybacky-form-screenshot-allowed"),r=document.getElementById("feedybacky-form-metadata-allowed"),c=document.getElementById("feedybacky-form-history-allowed"),d=document.getElementById("feedybacky-form-terms-accepted"),l=document.getElementById("feedybacky-form-personal-data-accepted"),h=o?o.checked:this.params.screenshotField==checkboxAutoEnableOption,m=r?r.checked:this.params.metadataField==checkboxAutoEnableOption,y=c?c.checked:this.params.historyField==checkboxAutoEnableOption;n.termsAccepted=!!d&&d.checked,n.personalDataAccepted=!!l&&l.checked,n.termsAccepted&&localStorage.setItem(termsAcceptedStorageItem,1),n.personalDataAccepted&&localStorage.setItem(personalDataAcceptedStorageItem,1),m&&(n.agent=navigator.userAgent,n.cookies=document.cookie,n.platform=navigator.platform,n.adBlock=!!this.params.adBlockDetected,n.screenSize=`${screen.width}x${screen.height}`,n.availableScreenSize=`${screen.availWidth}x${screen.availHeight}`,n.innerSize=`${window.innerWidth}x${window.innerHeight}`,n.colorDepth=screen.colorDepth,screen.orientation&&(n.orientation=screen.orientation.type),n.cookieEnabled=navigator.cookieEnabled,n.browserLanguage=navigator.language,n.referrer=document.referrer,n.pixelRatio=window.devicePixelRatio,n.offsetX=window.pageXOffset,n.offsetY=window.pageYOffset),y&&(this.historyLimit&&(this.eventHistory=this.eventHistory.slice(Math.max(this.eventHistory.length-this.historyLimit,0))),n.history=this.eventHistory),this.params.urlTracking&&(n.visitedUrls=this.visitedUrls),this.extraInfoFunction&&(n.extraInfo=this.extraInfoFunction()),this.showAlertContainer("pending"),h&&this.params.allowScreenshotModification&&this.modifiedScreenshot?(n.image=this.modifiedScreenshot,this.handleBeforeSubmitCallback(n),this.sendPostRequest(this.params.onSubmitUrl,n)):h?this.getScreenshot().then((e=>{n.image=e,this.handleBeforeSubmitCallback(n),this.sendPostRequest(this.params.onSubmitUrl,n)})):(this.handleBeforeSubmitCallback(n),this.sendPostRequest(this.params.onSubmitUrl,n)),"text"==this.params.activeMessageType&&e&&(e.value="")}getScreenshotMethodHtml2Canvas(){return new Promise((e=>{let t=window.pageYOffset;html2canvas(document.body,{onrendered:s=>{window.scrollTo(0,t),e(s.toDataURL("image/png"))}})}))}getScreenshotMethodMediaDevice(){return new Promise((e=>{let t=document.getElementById("feedybacky-screenshot-media-device-canvas"),s=document.getElementById("feedybacky-screenshot-media-device-video");t||(t=document.createElement("canvas"),t.setAttribute("id","feedybacky-screenshot-media-device-canvas")),s||(s=document.createElement("video"),s.setAttribute("id","feedybacky-screenshot-media-device-video"),s.setAttribute("autoplay",""));const a={video:!0},i={video:{mediaSource:"window"}};let n=null;if("undefined"!=typeof RTCIceGatherer)n=navigator.getDisplayMedia(a);else if(navigator.mediaDevices&&void 0!==navigator.mediaDevices.getDisplayMedia)n=navigator.mediaDevices.getDisplayMedia(a);else{if(!navigator.mediaDevices)return console.error("No media device is available - screenshot cannot be taken"),void e(null);n=navigator.mediaDevices.getUserMedia(i)}n.then((a=>{let i=window.outerWidth-window.innerWidth,n=window.outerHeight-window.innerHeight,o=window.innerWidth,r=window.innerHeight,c=window.innerWidth,d=window.innerHeight;i>200&&(i=100,o=window.outerWidth,c=window.outerWidth),n>200&&(n=100,r=window.outerHeight,d=window.outerHeight),t.width=document.body.clientWidth,t.height=document.body.clientHeight,window.stream=a,s.srcObject=a,setTimeout((()=>{if("ImageCapture"in window){const s=a.getVideoTracks();let l=null;for(let e=0;e<s.length;++e)if(!s[e].label.includes("camera")){l=s[e];break}if(l){new ImageCapture(l).grabFrame().then((s=>{l.stop(),t.width=c,t.height=d,t.getContext("2d").drawImage(s,i,n,o,r,0,0,c,d),e(t.toDataURL("image/png"))}))}else console.error("Cannot find video track other than camera"),e(null)}else console.warn("ImageCapture is not available"),t.width=s.videoWidth,t.height=s.videoHeight,t.getContext("2d").drawImage(s,0,0,t.width,t.height),e(t.toDataURL("image/png"))}),500)})).catch((e=>console.error(e)))}))}sendPostRequest(e,t){fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>{200==e.status||201==e.status?(this.showAlertContainer("success"),this.onSubmitUrlSuccess&&e.text().then((t=>{this.onSubmitUrlSuccess(e.status,t)})),this.screenshotModification.canvas&&(this.clearScreenshotModification(),this.modifiedScreenshot=this.screenshotModification.canvas.toDataURL())):(this.showAlertContainer("error",e.status),this.onSubmitUrlError&&e.text().then((t=>{this.onSubmitUrlError(e.status,t)})))})).catch((e=>{this.showAlertContainer("error",e)}))}initEventHistoryGathering(){let e=["change","click","focus","reset","submit"];for(let t=0;t<e.length;++t)document.addEventListener(e[t],(e=>{if(e.target.id&&!/^feedybacky/.test(e.target.id)){let t={eventType:e.type,tagName:e.target.tagName.toLowerCase()};e.target.id&&(t.id=e.target.id),e.target.className&&(t.className=e.target.className),e.target.getAttribute("name")&&(t.name=e.target.getAttribute("name")),e.target.value&&(t.value=e.target.value),this.eventHistory.push(t)}}))}initUrlTracking(){this.visitedUrls=localStorage.getItem(visitedUrlsStorageItem)||"[]",this.visitedUrls=JSON.parse(this.visitedUrls),this.saveVisitedUrl(),(e=>{const t=e.pushState;e.pushState=(s,...a)=>{"function"==typeof e.onpushstate&&e.onpushstate({state:s});const i=t.call(e,s,...a);return this.saveVisitedUrl(),i}})(window.history),window.addEventListener("popstate",(e=>{this.saveVisitedUrl()})),window.addEventListener("hashchange",(e=>{this.saveVisitedUrl()}))}saveVisitedUrl(){const e=window.location.href;this.visitedUrls.push({timestamp:Date.now(),url:e}),this.visitedUrls=this.visitedUrls.slice(Math.max(this.visitedUrls.length-this.urlTrackingLimit,0)),localStorage.setItem(visitedUrlsStorageItem,JSON.stringify(this.visitedUrls))}handleBeforeSubmitCallback(e){this.beforeSubmitFunction&&this.beforeSubmitFunction(e)}showMinimalContainer(){this.extendedContainer.style.display="none",this.minifiedContainer.style.display="block"}showExtendedContainer(){this.minifiedContainer.style.display="none",this.extendedContainer.style.display="block";const e=document.getElementById("feedybacky-form-description");e&&e.focus()}showAlertContainer(e,t){this.params.alertAfterRequest&&(this.alertContainer.classList="","success"===e?(this.alertContainer.innerHTML=this.params.texts.requestSuccess,this.alertContainer.classList="feedybacky-alert-container-success feedybacky-alert-container-animated"):"error"===e?(this.alertContainer.innerHTML=this.params.texts.requestFail,this.alertContainer.innerHTML+=" "+(this.defaultVars.texts["error"+t]||"error "+t),this.alertContainer.classList="feedybacky-alert-container-failure feedybacky-alert-container-animated"):"pending"===e&&(this.alertContainer.innerHTML=this.params.texts.requestPending,this.alertContainer.classList="feedybacky-alert-container-pending"),this.alertContainer.style.display="inline-block","pending"!==e&&setTimeout((()=>{this.alertContainer.style.display="none"}),3e3))}initializeDrawing(e){this.screenshotModification.canvas&&this.screenshotModification.ctx.clearRect(0,0,this.screenshotModification.canvas.width,this.screenshotModification.canvas.height);const t=document.getElementById("feedybacky-canvas-container");var s=document.createElement("canvas");s.id="can",s.width=.8*window.innerWidth,s.height=.8*window.innerHeight*(document.body.clientWidth/window.innerWidth);const a=s.getContext("2d"),i=new Image;i.src=e,i.onload=()=>{this.screenshotModification.baseImage=i,a.drawImage(i,0,0,s.width,s.height)},t.prepend(s),t.style.height=`${s.height}px`,this.screenshotModification.canvas=document.getElementById("can"),this.screenshotModification.ctx=this.screenshotModification.canvas.getContext("2d"),this.screenshotModification.canvas.addEventListener("mousemove",(e=>{this.findXYOnScreenshot("move",e)}),!1),this.screenshotModification.canvas.addEventListener("mousedown",(e=>{this.findXYOnScreenshot("down",e)}),!1),this.screenshotModification.canvas.addEventListener("mouseup",(e=>{this.findXYOnScreenshot("up",e)}),!1),this.screenshotModification.canvas.addEventListener("mouseout",(e=>{this.findXYOnScreenshot("out",e)}),!1)}findXYOnScreenshot(e,t){"down"==e&&(this.screenshotModification.prevX=this.screenshotModification.currX,this.screenshotModification.prevY=this.screenshotModification.currY,this.screenshotModification.currX=t.clientX-this.screenshotModification.canvas.offsetLeft,this.screenshotModification.currY=t.clientY-this.screenshotModification.canvas.offsetTop,this.screenshotModification.flag=!0,this.screenshotModification.dotFlag=!0,this.screenshotModification.dotFlag&&(this.screenshotModification.ctx.beginPath(),this.screenshotModification.ctx.fillStyle=this.screenshotModification.selectedColor,this.screenshotModification.ctx.fillRect(this.screenshotModification.currX,this.screenshotModification.currY,2,2),this.screenshotModification.ctx.closePath(),this.screenshotModification.dotFlag=!1)),"up"!=e&&"out"!=e||(this.screenshotModification.flag=!1),"move"==e&&this.screenshotModification.flag&&(this.screenshotModification.prevX=this.screenshotModification.currX,this.screenshotModification.prevY=this.screenshotModification.currY,this.screenshotModification.currX=t.clientX-this.screenshotModification.canvas.offsetLeft,this.screenshotModification.currY=t.clientY-this.screenshotModification.canvas.offsetTop,this.drawOnScreenshot())}drawOnScreenshot(){this.screenshotModification.ctx.beginPath(),this.screenshotModification.ctx.moveTo(this.screenshotModification.prevX,this.screenshotModification.prevY),this.screenshotModification.ctx.lineTo(this.screenshotModification.currX,this.screenshotModification.currY),this.screenshotModification.ctx.strokeStyle=this.screenshotModification.selectedColor,this.screenshotModification.ctx.lineWidth=this.screenshotModification.lineWidthPx,this.screenshotModification.ctx.stroke(),this.screenshotModification.ctx.closePath()}clearScreenshotModification(){this.screenshotModification.ctx.clearRect(0,0,this.screenshotModification.canvas.width,this.screenshotModification.canvas.height),this.screenshotModification.ctx.drawImage(this.screenshotModification.baseImage,0,0,this.screenshotModification.canvas.width,this.screenshotModification.canvas.height)}saveScreenshotModification(){this.modifiedScreenshot=this.screenshotModification.canvas.toDataURL(),document.getElementById("feedybacky-screen-modification-modal").style.display="none"}getScreenshot(){return new Promise((e=>{"html2canvas"==this.screenshotMethod?this.getScreenshotMethodHtml2Canvas().then((t=>{e(t)})):"mediaDevice"==this.screenshotMethod&&this.getScreenshotMethodMediaDevice().then((t=>{e(t)}))}))}importDependencies(){const e=document.getElementsByTagName("script");for(let t=e.length-1;t>=0;--t){let s=e[t].src,a=(s.length,s.split("/"));if(a[a.length-1].includes("feedybacky.min.js")){this.basePath=a.slice(0,-2).join("/");break}}this.basePath&&(this.importCssFile(`${this.basePath}/css/feedybacky.min.css`),this.importJsFile(`${this.basePath}/dependencies/html2canvas/html2canvas.min.js`))}importCssFile(e){const t=document.getElementsByTagName("head")[0];let s=document.createElement("link");s.href=e,s.type="text/css",s.rel="stylesheet",t.append(s)}importJsFile(e){const t=document.getElementsByTagName("body")[0];let s=document.createElement("script");s.src=e,s.type="text/javascript",t.append(s)}async loadJsonFile(e,t,s){try{t(await(await fetch(e)).json())}catch(e){s&&await s(e)}}}"undefined"!=typeof module&&(module.exports.FeedybackyPayload=FeedybackyPayload,module.exports.Feedybacky=Feedybacky);